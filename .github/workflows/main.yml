# Имя workflow, оно будет использоваться в интерфейсе GitHub Actions
name: Main Taski Workflow

# Перечень событий-триггеров, при которых должен запускаться workflow. Триггеров может быть несколько
on:
  # Событие push (это и есть git push) возникает, когда изменения исходного кода приходят на сервер GitHub
  push:
    # Отслеживаем изменения только в ветке (branches) main
    branches:
      - main

# Список действий, которые должны выполниться после срабатывания триггера
jobs:
  # Задача, которую будем выпонлнять (имя задачи даем сами)
  tests:
    # Определяет, в каком окружении будут запущены все команды этой задачи. Окружение создаёт на своём сервере GitHub Actions.
    runs-on: ubuntu-latest

    # Блок services аналогичен docker-compose.yml
    services:
      postgres:
        image: postgres:13.10
        # Указываем имя тестовой базы, имя и пароль пользователя в открытом виде,
        # ведь эта база будет работать только во время прогона тестов
        env:
          POSTGRES_USER: django_user
          POSTGRES_PASSWORD: django_password
          POSTGRES_DB: django_db
        ports:
          - 5432:5432
        # Эта конструкция описывает проверку готовности сервиса postgres
        # Если её не будет, то тесты могут запуститься раньше, чем сервер PostgreSQL
        # В результате тесты опять решат, что базы нет, — и упадут
        options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5


    # Каждая отдельная задача делится на шаги — steps. Каждый шаг — это отдельная команда.
    # Перечень шагов форматируется в виде списка словарей ":" (словарь)
    # В начале каждого шага ставится символ "-" (список)
    steps:
      # На GitHub Actions есть готовые описания шагов, их можно использовать в своих workflow.
      # Применим готовое описание шага для получения исходного кода
      # Каждому шагу можно дать имя — для этого применяется ключ name. Имя шага задаём сами (например, Check out code)

      # Копируем код проекта в рабочую директорию раннера
      - name: Check out code 
        # Для подключения стороннего workflow вместо ключа run применяется ключ uses
        # Берём готовое решение из библиотеки GitHub Actions
        uses: actions/checkout@v3
        
      # Устанавливаем Python - берём готовое решение из библиотеки GitHub Actions
      - name: Set up Python
        uses: actions/setup-python@v4
        # В action setup-python@v4 передаём параметр — версию Python
        with:
          python-version: 3.9

      # Обновляем pip, устанавливаем flake8 и flake8-isort, устанавливаем зависимости проекта
      - name: Install dependencies
        # В ключе run хранится команда, которая будет выполнена в терминале окружения на раннере (на сервере для выполнения задач, который предоставлен сервисом GitHub Actions)
        # Если надо выполнить сразу несколько команд, после run ставится символ | (вертикальная черта, pipe) и ниже построчно пишутся команды:
        run: |
          python -m pip install --upgrade pip 
          pip install flake8==6.0.0 flake8-isort==6.0.0
          pip install -r ./backend/requirements.txt 
      
      # Этот шаг дополним переменными для доступа к БД
      - name: Test with flake8 and django tests
      # Добавляем env-переменные для доступа к БД
        env:
          POSTGRES_USER: django_user
          POSTGRES_PASSWORD: django_password
          POSTGRES_DB: django_db
          # Сервер БД запущен в Docker, но его порт проброшен на хост
          # Поэтому подключаемся к 127.0.0.1:5432
          DB_HOST: 127.0.0.1
          DB_PORT: 5432

      # Запускаем flake8 и тесты из tests.py (из backend/api)
      - name: Test with flake8 and django tests
        # В ключе run хранится команда, которая будет выполнена в терминале окружения на раннере (на сервере для выполнения задач, который предоставлен сервисом GitHub Actions)
        # Вызываем flake8 и указываем ему, что нужно проверить файлы только в папке backend/
        # Далее перейти в папку backend (cd backend/) и запустить все тесты проекта (python manage.py test)
        run: |
          python -m flake8 backend/
          cd backend/
          python manage.py test
